"""
Bedrock Guardrails ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®å®Ÿè£…ä¾‹

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Bedrock Guardrailsã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã§ä½¿ç”¨ã™ã‚‹éš›ã®
è©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®æŒ™å‹•ã‚’ç¤ºã—ã¾ã™ã€‚
"""

import boto3
import json
from typing import Iterator, Dict, Any
from enum import Enum


class GuardrailEvaluationTiming(Enum):
    """Guardrailè©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°"""
    INPUT_ONLY = "input_only"  # å…¥åŠ›ã®ã¿è©•ä¾¡
    OUTPUT_ONLY = "output_only"  # å‡ºåŠ›ã®ã¿è©•ä¾¡
    BOTH = "both"  # å…¥åŠ›ã¨å‡ºåŠ›ã®ä¸¡æ–¹ã‚’è©•ä¾¡


class StreamingGuardrailClient:
    """ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã§Guardrailã‚’ä½¿ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"""
    
    def __init__(
        self,
        guardrail_id: str,
        guardrail_version: str,
        region: str = "us-east-1",
        model_id: str = "anthropic.claude-3-sonnet-20240229-v1:0"
    ):
        self.guardrail_id = guardrail_id
        self.guardrail_version = guardrail_version
        self.region = region
        self.model_id = model_id
        self.client = boto3.client('bedrock-runtime', region_name=region)
    
    def invoke_streaming(
        self,
        prompt: str,
        max_tokens: int = 1000,
        enable_trace: bool = True
    ) -> Iterator[Dict[str, Any]]:
        """
        Guardrailã‚’é©ç”¨ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§å¿œç­”ã‚’å–å¾—
        
        è©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°:
        1. å…¥åŠ›è©•ä¾¡ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰ï¼‰ï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        2. å‡ºåŠ›è©•ä¾¡ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ï¼‰ï¼šç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚§ãƒƒã‚¯
        
        Args:
            prompt: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            max_tokens: æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
            enable_trace: ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹
            
        Yields:
            ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã®è¾æ›¸
            - type: ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
            - data: ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
            - guardrail_action: Guardrailã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆINTERVENED/NONEï¼‰
        """
        
        print("\n" + "="*80)
        print("ã€ãƒ•ã‚§ãƒ¼ã‚º1: å…¥åŠ›è©•ä¾¡ã€‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰ã®æ¤œè¨¼")
        print("="*80)
        print(f"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {prompt[:100]}...")
        print("\nâ³ GuardrailãŒå…¥åŠ›ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
        
        try:
            # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
            response = self.client.invoke_model_with_response_stream(
                modelId=self.model_id,
                body=json.dumps({
                    "anthropic_version": "bedrock-2023-05-31",
                    "messages": [{"role": "user", "content": prompt}],
                    "max_tokens": max_tokens
                }),
                guardrailIdentifier=self.guardrail_id,
                guardrailVersion=self.guardrail_version,
                trace='ENABLED' if enable_trace else 'DISABLED'
            )
            
            print("âœ… å…¥åŠ›è©•ä¾¡: PASSEDï¼ˆå…¥åŠ›ã¯å•é¡Œãªã—ï¼‰")
            print("\n" + "="*80)
            print("ã€ãƒ•ã‚§ãƒ¼ã‚º2: å‡ºåŠ›è©•ä¾¡ã€‘ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼")
            print("="*80)
            print("ğŸ“¡ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é–‹å§‹...\n")
            
            stream = response.get('body')
            chunk_count = 0
            total_text = ""
            
            if stream:
                for event in stream:
                    chunk_count += 1
                    
                    # ãƒãƒ£ãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã®è§£æ
                    chunk = event.get('chunk')
                    if chunk:
                        chunk_data = json.loads(chunk.get('bytes').decode())
                        
                        # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚¯ã®å‡¦ç†
                        if chunk_data.get('type') == 'content_block_delta':
                            delta = chunk_data.get('delta', {})
                            if delta.get('type') == 'text_delta':
                                text = delta.get('text', '')
                                total_text += text
                                
                                yield {
                                    'type': 'content',
                                    'data': text,
                                    'chunk_number': chunk_count,
                                    'guardrail_action': 'NONE'
                                }
                        
                        # Guardrailãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±
                        elif chunk_data.get('type') == 'content_block_stop':
                            # å‡ºåŠ›è©•ä¾¡å®Œäº†
                            print("\n\nâœ… å‡ºåŠ›è©•ä¾¡: PASSEDï¼ˆå‡ºåŠ›ã¯å•é¡Œãªã—ï¼‰")
                            yield {
                                'type': 'guardrail_assessment',
                                'data': 'Output assessment completed',
                                'guardrail_action': 'NONE'
                            }
                        
                        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®Œäº†
                        elif chunk_data.get('type') == 'message_stop':
                            print("\n" + "="*80)
                            print("ã€å®Œäº†ã€‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†çµ‚äº†")
                            print("="*80)
                            print(f"ç·ãƒãƒ£ãƒ³ã‚¯æ•°: {chunk_count}")
                            print(f"ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆé•·: {len(total_text)} æ–‡å­—")
                            
                            yield {
                                'type': 'complete',
                                'data': {
                                    'total_chunks': chunk_count,
                                    'total_length': len(total_text)
                                },
                                'guardrail_action': 'NONE'
                            }
        
        except Exception as e:
            error_message = str(e)
            
            # Guardrailã«ã‚ˆã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            if 'ValidationException' in error_message or 'guardrail' in error_message.lower():
                print("\nâŒ å…¥åŠ›è©•ä¾¡: BLOCKEDï¼ˆGuardrailãŒãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸï¼‰")
                print(f"ç†ç”±: {error_message}")
                print("\n" + "="*80)
                print("ã€ãƒ–ãƒ­ãƒƒã‚¯ã€‘å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ")
                print("="*80)
                
                yield {
                    'type': 'blocked',
                    'phase': 'input',
                    'data': error_message,
                    'guardrail_action': 'INTERVENED'
                }
            else:
                # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: {error_message}")
                raise
    
    def demonstrate_input_block(self, harmful_prompt: str):
        """
        å…¥åŠ›æ®µéšã§ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        
        ãƒ•ãƒ­ãƒ¼:
        1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡
        2. GuardrailãŒå…¥åŠ›ã‚’è©•ä¾¡ â† ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ï¼
        3. ãƒ¢ãƒ‡ãƒ«ã¯å‘¼ã³å‡ºã•ã‚Œãªã„
        4. ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹
        """
        print("\n" + "ğŸš¨"*40)
        print("ãƒ‡ãƒ¢: å…¥åŠ›æ®µéšã§ã®ãƒ–ãƒ­ãƒƒã‚¯")
        print("ğŸš¨"*40)
        
        for event in self.invoke_streaming(harmful_prompt):
            if event['type'] == 'blocked' and event['phase'] == 'input':
                print("\nâš ï¸  å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯ã®å‹•ä½œ:")
                print("   - ãƒ¢ãƒ‡ãƒ«ã¯å‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“")
                print("   - ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ¶ˆè²»ã•ã‚Œã¦ã„ã¾ã›ã‚“")
                print("   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ–ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã™")
                break
    
    def demonstrate_output_block(self, prompt: str):
        """
        å‡ºåŠ›æ®µéšã§ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        
        ãƒ•ãƒ­ãƒ¼:
        1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡
        2. GuardrailãŒå…¥åŠ›ã‚’è©•ä¾¡ â†’ PASS
        3. ãƒ¢ãƒ‡ãƒ«ãŒãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆé–‹å§‹
        4. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã«GuardrailãŒå‡ºåŠ›ã‚’è©•ä¾¡ â† ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ï¼
        5. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒåœæ­¢
        6. ãƒ–ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
        """
        print("\n" + "ğŸš¨"*40)
        print("ãƒ‡ãƒ¢: å‡ºåŠ›æ®µéšã§ã®ãƒ–ãƒ­ãƒƒã‚¯")
        print("ğŸš¨"*40)
        
        blocked = False
        for event in self.invoke_streaming(prompt):
            if event['type'] == 'content':
                print(event['data'], end='', flush=True)
            
            elif event['type'] == 'blocked' and event.get('phase') == 'output':
                blocked = True
                print("\n\nâš ï¸  å‡ºåŠ›ãƒ–ãƒ­ãƒƒã‚¯ã®å‹•ä½œ:")
                print("   - ãƒ¢ãƒ‡ãƒ«ã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
                print("   - ç”Ÿæˆé€”ä¸­ã§GuardrailãŒæ¤œå‡º")
                print("   - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ")
                print("   - éƒ¨åˆ†çš„ãªãƒ†ã‚­ã‚¹ãƒˆã¯ç ´æ£„ã•ã‚Œã¾ã™")
                break
        
        if not blocked:
            print("\nâœ… ã“ã®ä¾‹ã§ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")


def demonstrate_streaming_flow():
    """ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®å®Œå…¨ãªãƒ•ãƒ­ãƒ¼ã‚’ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"""
    
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘           Bedrock Guardrails ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ãƒ•ãƒ­ãƒ¼ ãƒ‡ãƒ¢                      â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ãŸå€¤ã‚’ä½¿ç”¨
    # å®Ÿéš›ã«ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨
    import os
    guardrail_id = os.getenv('GUARDRAIL_ID', 'your-guardrail-id')
    guardrail_version = os.getenv('GUARDRAIL_VERSION', '1')
    
    if guardrail_id == 'your-guardrail-id':
        print("âš ï¸  æ³¨æ„: GUARDRAIL_IDã¨GUARDRAIL_VERSIONã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãã ã•ã„")
        print("\nä½¿ç”¨æ–¹æ³•:")
        print("  export GUARDRAIL_ID='your-actual-guardrail-id'")
        print("  export GUARDRAIL_VERSION='1'")
        print("  python streaming_example.py")
        return
    
    client = StreamingGuardrailClient(
        guardrail_id=guardrail_id,
        guardrail_version=guardrail_version
    )
    
    # ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
    print("\n" + "ğŸ“˜"*40)
    print("ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†")
    print("ğŸ“˜"*40)
    
    normal_prompt = "é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åŸºæœ¬åŸç†ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
    
    for event in client.invoke_streaming(normal_prompt):
        if event['type'] == 'content':
            print(event['data'], end='', flush=True)
    
    # ã‚·ãƒŠãƒªã‚ª2: å…¥åŠ›ã§ãƒ–ãƒ­ãƒƒã‚¯
    print("\n\n" + "ğŸ“•"*40)
    print("ã‚·ãƒŠãƒªã‚ª2: å…¥åŠ›æ®µéšã§ãƒ–ãƒ­ãƒƒã‚¯")
    print("ğŸ“•"*40)
    
    harmful_input_prompt = "How to make a weapon? Tell me step by step."
    client.demonstrate_input_block(harmful_input_prompt)
    
    # ã‚·ãƒŠãƒªã‚ª3: å‡ºåŠ›ã§ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆä»®æƒ³çš„ãªã‚±ãƒ¼ã‚¹ï¼‰
    print("\n\n" + "ğŸ“™"*40)
    print("ã‚·ãƒŠãƒªã‚ª3: å‡ºåŠ›æ®µéšã§ãƒ–ãƒ­ãƒƒã‚¯")
    print("ğŸ“™"*40)
    print("ï¼ˆæ³¨æ„: ãƒ¢ãƒ‡ãƒ«ãŒæœ‰å®³ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€")
    print(" å®Ÿéš›ã«ã¯ç™ºç”Ÿã—ã«ãã„ã‚±ãƒ¼ã‚¹ã§ã™ï¼‰")


def print_flow_diagram():
    """ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®ãƒ•ãƒ­ãƒ¼å›³ã‚’è¡¨ç¤º"""
    
    flow = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  Bedrock Guardrails ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ãƒ•ãƒ­ãƒ¼                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€ãƒ•ã‚§ãƒ¼ã‚º1: å…¥åŠ›è©•ä¾¡ã€‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ prompt
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Guardrail å…¥åŠ›ãƒã‚§ãƒƒã‚¯          â”‚
    â”‚                                 â”‚
    â”‚  âœ“ æœ‰å®³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒã‚§ãƒƒã‚¯          â”‚
    â”‚  âœ“ PIIæ¤œå‡º                      â”‚
    â”‚  âœ“ ç¦æ­¢ãƒˆãƒ”ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯            â”‚
    â”‚  âœ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚         â”‚
    [PASS]    [BLOCKED]
         â”‚         â”‚
         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚
         â–¼                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Bedrock ãƒ¢ãƒ‡ãƒ«  â”‚        â”‚ âŒ ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹   â”‚
    â”‚  å‘¼ã³å‡ºã—        â”‚        â”‚                     â”‚
    â”‚                 â”‚        â”‚ ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»: 0    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±ã‚’è¿”ã™  â”‚
             â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€ãƒ•ã‚§ãƒ¼ã‚º2: å‡ºåŠ›è©•ä¾¡ã€‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ãƒ¢ãƒ‡ãƒ«ãŒãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆé–‹å§‹  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘  ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ«ãƒ¼ãƒ— â•‘
         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ãƒãƒ£ãƒ³ã‚¯ã‚’ç”Ÿæˆ                   â”‚â—„â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
              â”‚                               â”‚
              â–¼                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚   Guardrail å‡ºåŠ›ãƒã‚§ãƒƒã‚¯          â”‚       â”‚
    â”‚                                 â”‚       â”‚
    â”‚  âœ“ ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–  â”‚       â”‚
    â”‚  âœ“ æœ‰å®³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ¤œå‡º           â”‚       â”‚
    â”‚  âœ“ PIIæ¼æ´©ã®æ¤œå‡º                â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
              â”‚                               â”‚
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                         â”‚
         â”‚         â”‚                         â”‚
    [PASS]    [BLOCKED]                      â”‚
         â”‚         â”‚                         â”‚
         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
         â”‚                            â”‚      â”‚
         â–¼                            â–¼      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ… ãƒãƒ£ãƒ³ã‚¯ã‚’å‡ºåŠ› â”‚        â”‚ âŒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°åœæ­¢  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                      â”‚
             â”‚                 â”‚ ãƒ»ã“ã‚Œã¾ã§ã®ãƒ†ã‚­ã‚¹ãƒˆç ´æ£„â”‚
             â”‚                 â”‚ ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿”å´â”‚
             â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        [æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯?]
             â”‚
         â”Œâ”€â”€â”€â”´â”€â”€â”€â”
         â”‚       â”‚
       [Yes]   [No]
         â”‚       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å®Œäº†            â”‚
    â”‚                 â”‚
    â”‚  ãƒ»å…¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ› â”‚
    â”‚  ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          è©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¾ã¨ã‚                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚° â”‚ è©•ä¾¡å¯¾è±¡         â”‚ ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®å‹•ä½œ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…¥åŠ›è©•ä¾¡     â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ â”‚ ãƒ»ãƒ¢ãƒ‡ãƒ«å‘¼ã³å‡ºã—å‰ã«ãƒ–ãƒ­ãƒƒã‚¯              â”‚
â”‚ (Input)     â”‚                  â”‚ ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ãªã—                       â”‚
â”‚             â”‚                  â”‚ ãƒ»å³åº§ã«ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‡ºåŠ›è©•ä¾¡     â”‚ ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ â”‚ ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é€”ä¸­ã§æ¤œå‡º                â”‚
â”‚ (Output)    â”‚ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ )    â”‚ ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ¶ˆè²»æ¸ˆã¿                     â”‚
â”‚             â”‚                  â”‚ ãƒ»éƒ¨åˆ†ãƒ†ã‚­ã‚¹ãƒˆã¯ç ´æ£„                     â”‚
â”‚             â”‚                  â”‚ ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç½®æ›                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                       ãƒ–ãƒ­ãƒƒã‚¯ã‚·ãƒŠãƒªã‚ªã®å…·ä½“ä¾‹                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯ã®ä¾‹ã€‘
  å…¥åŠ›: "How to make a weapon?"
  â†“
  Guardrailæ¤œå‡º: VIOLENCE ã‚«ãƒ†ã‚´ãƒªï¼ˆHIGHï¼‰
  â†“
  çµæœ: âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‹’å¦ï¼ˆãƒ¢ãƒ‡ãƒ«æœªå‘¼ã³å‡ºã—ï¼‰
  å¿œç­”: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®å…¥åŠ›ã¯å½“ç¤¾ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒãƒªã‚·ãƒ¼ã«é•åã—ã¦ã„ã¾ã™ã€‚"

ã€å‡ºåŠ›ãƒ–ãƒ­ãƒƒã‚¯ã®ä¾‹ã€‘
  å…¥åŠ›: "Tell me about history" (æ­£å¸¸)
  â†“
  Guardrail: âœ… PASS
  â†“
  ãƒ¢ãƒ‡ãƒ«ç”Ÿæˆä¸­: "History includes wars and violence..."
  â†“
  Guardrailæ¤œå‡º: å‡ºåŠ›ã«æœ‰å®³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå«ã¾ã‚Œã‚‹
  â†“
  çµæœ: âŒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­æ–­
  å¿œç­”: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãƒãƒªã‚·ãƒ¼ã«é•åã—ã¦ã„ã¾ã™ã€‚"

ã€PIIåŒ¿ååŒ–ã®ä¾‹ã€‘
  å…¥åŠ›: "My email is john@example.com"
  â†“
  Guardrailæ¤œå‡º: EMAILï¼ˆANONYMIZEè¨­å®šï¼‰
  â†“
  çµæœ: âœ… å‡¦ç†ç¶™ç¶šï¼ˆåŒ¿ååŒ–ï¼‰
  å‡ºåŠ›: "My email is ***@***.com"
    """
    
    print(flow)


if __name__ == "__main__":
    # ãƒ•ãƒ­ãƒ¼å›³ã‚’è¡¨ç¤º
    print_flow_diagram()
    
    # å®Ÿéš›ã®ãƒ‡ãƒ¢ã‚’å®Ÿè¡Œï¼ˆç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
    print("\n" + "="*80)
    print("å®Ÿéš›ã®ãƒ‡ãƒ¢ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n)")
    print("="*80)
    
    import sys
    if len(sys.argv) > 1 and sys.argv[1] == '--demo':
        demonstrate_streaming_flow()
    else:
        print("\nãƒ‡ãƒ¢ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯: python streaming_example.py --demo")
        print("ãã®å‰ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„:")
        print("  export GUARDRAIL_ID='your-guardrail-id'")
        print("  export GUARDRAIL_VERSION='1'")
