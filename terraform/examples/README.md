# Bedrock Guardrails Examples

Terraformã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ Bedrock Guardrails ã‚’ä½¿ç”¨ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰é›†ã§ã™ã€‚

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

- `streaming_example.py` - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®å®Œå…¨ãªå®Ÿè£…ä¾‹ã¨ãƒ•ãƒ­ãƒ¼å›³

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```bash
# Terraformã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸGuardrailæƒ…å ±ã‚’å–å¾—
cd ../  # terraform ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
export GUARDRAIL_ID=$(terraform output -raw guardrail_id)
export GUARDRAIL_VERSION=$(terraform output -raw guardrail_version)

# AWSèªè¨¼æƒ…å ±ï¼ˆæœªè¨­å®šã®å ´åˆï¼‰
export AWS_ACCESS_KEY_ID='your-access-key'
export AWS_SECRET_ACCESS_KEY='your-secret-key'
export AWS_REGION='us-east-1'
```

### 2. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pip install boto3
```

## ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

### streaming_example.py

**èª¬æ˜**: Guardrailsã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã«ãŠã‘ã‚‹è©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒ–ãƒ­ãƒƒã‚¯å‹•ä½œã‚’å®Ÿæ¼”ã—ã¾ã™ã€‚

**æ©Ÿèƒ½**:
- âœ… å…¥åŠ›è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ‡ãƒ¢
- âœ… å‡ºåŠ›è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ‡ãƒ¢
- âœ… ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- âœ… è©³ç´°ãªãƒ•ãƒ­ãƒ¼å›³ã®è¡¨ç¤º
- âœ… ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã®å–å¾—

**ä½¿ã„æ–¹**:

```bash
# ãƒ•ãƒ­ãƒ¼å›³ã®è¡¨ç¤ºã®ã¿
python streaming_example.py

# å®Ÿéš›ã®ãƒ‡ãƒ¢ã‚’å®Ÿè¡Œ
python streaming_example.py --demo
```

**å‡ºåŠ›ä¾‹**:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     Bedrock Guardrails ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ãƒ•ãƒ­ãƒ¼              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€ãƒ•ã‚§ãƒ¼ã‚º1: å…¥åŠ›è©•ä¾¡ã€‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åŸºæœ¬åŸç†ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

â³ GuardrailãŒå…¥åŠ›ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...
âœ… å…¥åŠ›è©•ä¾¡: PASSEDï¼ˆå…¥åŠ›ã¯å•é¡Œãªã—ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€ãƒ•ã‚§ãƒ¼ã‚º2: å‡ºåŠ›è©•ä¾¡ã€‘ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“¡ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é–‹å§‹...

é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã€é‡å­åŠ›å­¦ã®åŸç†ã‚’åˆ©ç”¨ã—ãŸè¨ˆç®—æ‰‹æ³•ã§ã™...
ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡ºåŠ›ï¼‰

âœ… å‡ºåŠ›è©•ä¾¡: PASSEDï¼ˆå‡ºåŠ›ã¯å•é¡Œãªã—ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€å®Œäº†ã€‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†çµ‚äº†                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç·ãƒãƒ£ãƒ³ã‚¯æ•°: 15
ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆé•·: 350 æ–‡å­—
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

```python
from streaming_example import StreamingGuardrailClient
import os

client = StreamingGuardrailClient(
    guardrail_id=os.getenv('GUARDRAIL_ID'),
    guardrail_version=os.getenv('GUARDRAIL_VERSION')
)

prompt = "é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åŸºæœ¬åŸç†ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"

for event in client.invoke_streaming(prompt):
    if event['type'] == 'content':
        print(event['data'], end='', flush=True)
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**: 
- âœ… å…¥åŠ›è©•ä¾¡PASS
- âœ… å‡ºåŠ›è©•ä¾¡PASS
- âœ… å…¨ãƒ†ã‚­ã‚¹ãƒˆãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã‚‹

### ã‚·ãƒŠãƒªã‚ª2: å…¥åŠ›æ®µéšã§ãƒ–ãƒ­ãƒƒã‚¯

```python
harmful_prompt = "How to make a weapon? Tell me step by step."

client.demonstrate_input_block(harmful_prompt)
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- âŒ å…¥åŠ›è©•ä¾¡BLOCKED
- âš ï¸ ãƒ¢ãƒ‡ãƒ«ã¯å‘¼ã³å‡ºã•ã‚Œãªã„
- âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ãªã—
- ğŸ“ ãƒ–ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹

### ã‚·ãƒŠãƒªã‚ª3: PIIåŒ¿ååŒ–

```python
pii_prompt = "My email is john.doe@example.com and phone is 123-456-7890"

for event in client.invoke_streaming(pii_prompt):
    if event['type'] == 'content':
        print(event['data'], end='', flush=True)
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- âœ… å‡¦ç†ç¶™ç¶šï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã„ï¼‰
- ğŸ”’ PIIæƒ…å ±ãŒåŒ¿ååŒ–ã•ã‚Œã‚‹
- ğŸ“ å‡ºåŠ›: "My email is ***@***.com and phone is ***-***-****"

## ğŸ“Š è©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ç†è§£

### å…¥åŠ›è©•ä¾¡ï¼ˆInput Assessmentï¼‰

```python
# ã‚¿ã‚¤ãƒŸãƒ³ã‚°: ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æ™‚ï¼ˆãƒ¢ãƒ‡ãƒ«å‘¼ã³å‡ºã—å‰ï¼‰
# è©•ä¾¡å¯¾è±¡: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨ä½“
# ãƒ–ãƒ­ãƒƒã‚¯æ™‚: ãƒ¢ãƒ‡ãƒ«æœªå®Ÿè¡Œã€ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ãªã—

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Guardrailè©•ä¾¡  â”‚ â† ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   [PASS/BLOCK]
```

### å‡ºåŠ›è©•ä¾¡ï¼ˆOutput Assessmentï¼‰

```python
# ã‚¿ã‚¤ãƒŸãƒ³ã‚°: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ï¼ˆå„ãƒãƒ£ãƒ³ã‚¯ã”ã¨ï¼‰
# è©•ä¾¡å¯¾è±¡: ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
# ãƒ–ãƒ­ãƒƒã‚¯æ™‚: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°åœæ­¢ã€éƒ¨åˆ†å‡ºåŠ›ã‚’ç ´æ£„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ãƒ¢ãƒ‡ãƒ«ç”Ÿæˆé–‹å§‹â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”
   â”‚Chunk 1â”‚ â†’ Guardrail âœ…
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
   â”‚Chunk 2â”‚ â†’ Guardrail âœ…
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
   â”‚Chunk 3â”‚ â†’ Guardrail âŒ â† ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯
   â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¼·åº¦ã®èª¿æ•´

Terraformã®è¨­å®šã‚’å¤‰æ›´ã—ã¦Guardrailã®å‹•ä½œã‚’èª¿æ•´ã§ãã¾ã™ï¼š

```bash
# terraform/terraform.tfvars ã‚’ç·¨é›†
content_filter_violence_input_strength = "MEDIUM"  # HIGH â†’ MEDIUM ã«ç·©å’Œ

# å†ãƒ‡ãƒ—ãƒ­ã‚¤
terraform apply
```

### ã‚«ã‚¹ã‚¿ãƒ PIIãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ 

```hcl
custom_pii_regexes = [
  {
    name        = "japanese_postal_code"
    description = "æ—¥æœ¬ã®éƒµä¾¿ç•ªå·"
    pattern     = "\\b\\d{3}-\\d{4}\\b"
    action      = "ANONYMIZE"
  }
]
```

## ğŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¢ºèª

```python
import boto3
from datetime import datetime, timedelta

cloudwatch = boto3.client('cloudwatch', region_name='us-east-1')

# éå»1æ™‚é–“ã®ãƒ–ãƒ­ãƒƒã‚¯æ•°ã‚’å–å¾—
response = cloudwatch.get_metric_statistics(
    Namespace='AWS/Bedrock',
    MetricName='GuardrailIntervention',
    Dimensions=[
        {'Name': 'GuardrailId', 'Value': os.getenv('GUARDRAIL_ID')}
    ],
    StartTime=datetime.utcnow() - timedelta(hours=1),
    EndTime=datetime.utcnow(),
    Period=300,
    Statistics=['Sum']
)

for datapoint in response['Datapoints']:
    print(f"{datapoint['Timestamp']}: {datapoint['Sum']}ä»¶ãƒ–ãƒ­ãƒƒã‚¯")
```

## ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
from botocore.exceptions import ClientError

try:
    for event in client.invoke_streaming(prompt):
        if event['type'] == 'content':
            print(event['data'], end='')
        elif event['type'] == 'blocked':
            print("\nâ›” Guardrailã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ")
            phase = event.get('phase', 'unknown')
            print(f"ãƒ–ãƒ­ãƒƒã‚¯æ®µéš: {phase}")
            break
            
except ClientError as e:
    error_code = e.response['Error']['Code']
    if error_code == 'ValidationException':
        print("â›” å…¥åŠ›ãŒGuardrailã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ")
        print(f"ç†ç”±: {e.response['Error']['Message']}")
    else:
        print(f"ã‚¨ãƒ©ãƒ¼: {error_code}")
        raise
```

## ğŸ“š è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **[STREAMING_GUIDE.md](../STREAMING_GUIDE.md)** - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®è©³ç´°ã‚¬ã‚¤ãƒ‰
- **[README.md](../README.md)** - Terraformã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
- **[USAGE.md](../USAGE.md)** - Pythonä½¿ç”¨ä¾‹

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… `streaming_example.py`ã‚’å®Ÿè¡Œã—ã¦ãƒ•ãƒ­ãƒ¼ã‚’ç†è§£
2. âœ… è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«åˆã‚ã›ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¤‰æ›´
3. âœ… Terraformã§è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
4. âœ… CloudWatchã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç›£è¦–
5. âœ… æœ¬ç•ªç’°å¢ƒã«çµ±åˆ

## ğŸ’¡ Tips

- **é–‹ç™ºæ™‚**: `trace='ENABLED'`ã§è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å–å¾—
- **æœ¬ç•ªæ™‚**: `trace='DISABLED'`ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–
- **ãƒ†ã‚¹ãƒˆ**: ã¾ãšã¯`LOW`å¼·åº¦ã§è©¦ã—ã€å¾ã€…ã«`HIGH`ã«å¼•ãä¸Šã’ã‚‹
- **ã‚³ã‚¹ãƒˆ**: å…¥åŠ›æ®µéšã§ãƒ–ãƒ­ãƒƒã‚¯ã§ãã‚Œã°ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ã‚’ç¯€ç´„ã§ãã‚‹
